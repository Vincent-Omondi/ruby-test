<!DOCTYPE html>
<html>
  <head>
    <title>Test Project</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Always include Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    
    <!-- Always include Tailwind from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#3D2D1C',
              secondary: '#F8C05C',
              accent: '#4A90E2',
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              serif: ['Georgia', 'serif'],
            },
          }
        }
      }
    </script>
    
    <!-- Ensure we have basic styles applied -->
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', system-ui, sans-serif;
        color: #333;
        line-height: 1.5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }
    </style>
    
    <!-- Use try/catch for all asset includes to prevent 500 errors -->
    <% begin %>
      <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <% rescue => e %>
      <!-- Silently fail if application.css is missing -->
    <% end %>
    
    <% begin %>
      <%= stylesheet_link_tag "application.tailwind", "data-turbo-track": "reload" %>
    <% rescue => e %>
      <!-- Silently fail if application.tailwind.css is missing -->
    <% end %>
    
    <!-- Include React from CDN as a fallback -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <% begin %>
      <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
    <% rescue => e %>
      <!-- If application.js is missing, add a fallback script -->
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const appElement = document.getElementById('app');
          if (appElement) {
            appElement.innerHTML = `
              <div class="container mx-auto p-8 text-center">
                <h1 class="text-3xl font-bold mb-4">Welcome to the Application</h1>
                <p class="text-xl mb-4">This website is currently under maintenance</p>
                <div class="mt-8 bg-gray-100 p-6 rounded-lg">
                  <p class="mb-4">To run the app locally:</p>
                  <ol class="list-decimal list-inside text-left max-w-md mx-auto">
                    <li class="mb-2">Clone this repository:</li>
                    <code class="block bg-gray-200 p-2 rounded mb-4 text-sm overflow-x-auto">
                      git clone https://github.com/Vincent-Omondi/ruby-test.git
                    </code>
                    <li class="mb-2">Navigate to the project directory:</li>
                    <code class="block bg-gray-200 p-2 rounded mb-4 text-sm">
                      cd ruby-test
                    </code>
                    <li class="mb-2">Run the start script:</li>
                    <code class="block bg-gray-200 p-2 rounded mb-4 text-sm">
                      ./start.sh
                    </code>
                  </ol>
                  <div class="mt-6">
                    <a href="https://github.com/Vincent-Omondi/ruby-test" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-flex items-center px-4 py-2 bg-primary text-white rounded hover:bg-secondary">
                      <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                      </svg>
                      View on GitHub
                    </a>
                  </div>
                </div>
              </div>
            `;
          }
        });
      </script>
    <% end %>
  </head>

  <body>
    <%= content_for(:head) %>
    <% 
      # Prepare the Inertia data outside of the HTML
      inertia_data = if defined?(@inertia)
                       @inertia
                     elsif defined?(@inertia_data)
                       @inertia_data
                     else
                       nil
                     end
      
      # Always ensure URL is included if we have data
      if inertia_data
        inertia_data[:url] ||= request.original_url
        
        # Debug what's coming from the controller
        Rails.logger.debug "Inertia template received component: #{inertia_data[:component]}"
        
        # CRITICALLY IMPORTANT: Ensure component name is properly normalized
        # This prevents the blank white page issue when navigating to auth pages
        if inertia_data[:component].present?
          # Map Devise routes to proper component names - be very aggressive with replacements
          if inertia_data[:component].to_s == 'Sign_in' || request.path.include?('/users/sign_in')
            Rails.logger.debug "Fixing component name from #{inertia_data[:component]} to auth/Login"
            inertia_data[:component] = 'auth/Login'
          elsif inertia_data[:component].to_s == 'Sign_up' || request.path.include?('/users/sign_up')
            Rails.logger.debug "Fixing component name from #{inertia_data[:component]} to auth/Register"
            inertia_data[:component] = 'auth/Register'
          end
          
          # Ensure component name isn't altered if it includes slashes
          if inertia_data[:component].include?('/')
            inertia_data[:component] = inertia_data[:component].to_s
          end
        end
        
        # Don't try to manually merge shared data - it's already handled by the controller
        # Just make sure we have props with the proper structure
        inertia_data[:props] ||= {}
        inertia_data[:props][:errors] ||= {}
        
        # FORCE auth data to be included - for debugging
        if user_signed_in?
          inertia_data[:props][:auth] = {
            user: {
              id: current_user.id,
              email: current_user.email,
              admin: current_user.respond_to?(:has_role?) ? current_user.has_role?(:admin) : false
            }
          }
        else
          inertia_data[:props][:auth] = { user: nil }
        end
        
        data_attribute = raw(inertia_data.to_json)
      else 
        data_attribute = '{}'
      end
    %>
    <div id="app" data-page='<%= data_attribute %>'></div>
  </body>
</html> 